<html>
	<head>
		<title>
			DIV test
		</title>
		<link rel="stylesheet" href="gate.css" type="text/css" media="all" />
		<script src='js/raphael-min.js'>
		</script>
		<script src='js/jquery-1.5.1.min.js'>
		</script>
		<script>
			var g_page = null;
			var g_idx  = 1;
			var g_gates= {};

			function handle_circle(circ, fill, line, path_id, pivot) {
				circ.attr("fill",  fill);
				circ.data("line",  line);
				circ.data("idx",   path_id);
				circ.data("pivot", pivot);

				circ.drag(function(dx,dy) {
					var tx,ty,i,p,l,c;

					tx = Math.min(Math.max(this.x + dx, 15), 785);
					ty = Math.min(Math.max(this.y + dy, 15), 585);

				    this.attr({
						cx: tx,
						cy: ty
					});

					l = this.data("line");
					p =    l.attr("path");
					i = this.data("idx");

					p[i][1] = tx;
					p[i][2] = ty;
					l.attr({'path': p});

					c = calc_third(p);
					p = this.data("pivot");
					p.attr({x:c.x, y: c.y});

					$("#x0").text(p[0][1]);
					$("#y0").text(p[0][2]);
					$("#x1").text(p[1][1]);
					$("#y1").text(p[1][2]);
				  },
				  function() {
					  this.x = this.attr("cx");
					  this.y = this.attr("cy");
				  });
			}

			function calc_third(path) {
				var ang;
				var x,y;
				var x1,y1,x2,y2;
				var dist;

				x1 = path[0][1];
				y1 = path[0][2];
				x2 = path[1][1];
				y2 = path[1][2];
				ang = Raphael.angle(x2, y2, x1, y1);
				dist = Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));
				x   = x1 + dist /2 * Math.cos(Raphael.rad(ang));
				y   = y1 + dist /2 * Math.sin(Raphael.rad(ang));

				x   = x + 50 * Math.cos(Raphael.rad(ang+90));
				y   = y + 50 * Math.sin(Raphael.rad(ang+90));

				return {x:x, y:y};
			}


			function rename_gate() {
				var answer;

				answer = prompt("Label", this.attr("text"));
				if (answer == null)
					return;
				this.attr({text:answer});
				$("#lbl"+this.data('id')).text(answer);
			}


			function delete_gate(idx) {
				var answer;

				answer = confirm("Delete " + g_gates[idx].lbl.attr("text"));
				if (!answer)
					return;
				
				$("#lbl_info_"+idx).remove();
				g_gates[idx].start.remove();
				g_gates[idx].end.remove();
				g_gates[idx].line.remove();
				g_gates[idx].lbl.remove();

			}

			function new_gate() {
				var c1,c2,lbl, line;
				var path, coords
				var html;


				path = [["M", 200, 100], ["L", 350,100]];
				line = g_page.path(path);
				line.attr({stroke: Raphael.getColor(), "stroke-width": 4});
				c1 = g_page.circle(path[0][1], path[0][2], 10);
				c2 = g_page.circle(path[1][1], path[1][2], 10);
				coords = calc_third(path);
				lbl = g_page.text(coords.x,coords.y,"label"+g_idx).attr({'font-size':15});
				handle_circle(c1, "white", line, 0, lbl);
				handle_circle(c2, "green", line, 1, lbl);
				lbl.data({id: g_idx});
				lbl.click(rename_gate);
				g_gates[g_idx] = {start:c1, end:c2, line:line, lbl:lbl};

				html = "<table id='lbl_info_"+g_idx+"'><tr><td id='lbl"+g_idx+"'>"+lbl.attr("text")+"</td><td><input type='button' onclick='delete_gate("+g_idx+")' value='-'> </td></tr></table>";
				$("#info").append(html);


				g_idx++;
			}

			function update_background(item) {
				$(item).css("background-image","url('/broadcast.php')");
				if (item == "#bg")
					setTimeout(function() { update_background("#field"); } , 100)
			}

			function init() {
				var pos;

				g_page = Raphael(document.getElementById("field"), 800, 600);
				$("#add").click(new_gate);
				pos = $("#field").offset();
				$("#bg").offset(pos);

				setTimeout(function() { update_background("#field"); } , 1000)
			}


			$(document).ready(init);
		</script>
	<body>
		<p>Raphael test </p>	
		<div id="container">
			<div id="field" style="display:inline-block">
			</div>
			<div style="display:inline-block;vertical-align:top">
				<div id='info'></div>
				<input id="add" type="button" value="+"></input>
			</div>
		</div>

		<div id="bg">
		</div>
	</body>
</html>
